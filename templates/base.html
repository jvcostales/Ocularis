<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocularis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Schibsted+Grotesk:ital,wght@0,400..900;1,400..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</head>

<body class="loading {% if show_profile_modal %}no-scroll-body{% endif %}">
    <div id="loader">
        <img id="loader-logo" src="..\static\Logo-compressed.png" alt="Ocularis Logo" class="loader-logo">
    </div>
    <div class="app-content">
        <div class="container">
            <div class="left-sidebar-container">
                <div class="left-sidebar">
                    <div class="namelogo">
                        <a href="{{ url_for('feed') }}"><img id="logo" src="..\static\Logo.png" class="logo"></a>
                        <div class="name"><a href="{{ url_for('feed') }}">Ocularis</a></div>
                    </div>
                    <ul class="sidebar-menu">
                        <li><a href="{{ url_for('feed') }}">
                                <div class="icon-text-wrapper {% if current_page == 'feed' %}current{% endif %}">
                                    <span class="material-symbols-outlined sidebar-symbol">newspaper</span>
                                    <div>Feed</div>
                                </div>
                            </a></li>
                        <li><a href="{{ url_for('pairup') }}">
                                <div
                                    class="icon-text-wrapper {% if current_page in ['pairup', 'match'] %}current{% endif %}">
                                    <span class="material-symbols-outlined sidebar-symbol">group</span>
                                    <div>Match</div>
                                </div>
                            </a></li>
                        <li>
                            <a href="{{ url_for('profile', user_id=current_user.id) }}">
                                <div class="icon-text-wrapper 
            {% if current_page == 'profile' and is_own_profile %}current{% endif %}">
                                    <span class="material-symbols-outlined sidebar-symbol">person</span>
                                    <div>Profile</div>
                                </div>
                            </a>
                        </li>
                        <li><a href="{{ url_for('logout') }}">
                                <div class="icon-text-wrapper">
                                    <span class="material-symbols-outlined sidebar-symbol">logout</span>
                                    <div>Logout</div>
                                </div>
                            </a></li>
                    </ul>
                </div>
            </div>
            <div class="header">
                <form class="search-wrapper hide-mobile" action="{{ url_for('search_results') }}" method="GET">
                    <input id="desktopSearchInput" class="search" type="text" name="query" placeholder="Search"
                        required>
                    <button class="search-button" type="submit">
                        <span class="material-symbols-outlined search-symbol">search</span>
                    </button>
                </form>
                <div class="hide-pfp">

                    <div class="notifs-wrapper desktop-wrapper">
                        <button class="notifs-button">
                            <span class="material-symbols-outlined notifs-symbol">notifications</span>
                        </button>

                        <!-- Dropdown (initially hidden, shown via JS by adding 'dropdown-visible') -->
                        <div class="notifs-requests-dropdown" data-group="notifications" id="dropdown-desktop">
                            <div class="notifs" id="notifs-tablet">
                                <div class="notifs-title">Notifs</div>

                                {% if notifications %}
                                {% for display_name, action, image_id, created_at, actor_id, profile_pic, id in
                                notifications %}
                                <div class="notif-bar">
                                    <a href="{{ url_for('profile', user_id=actor_id) }}">
                                        <img src="{{ url_for('profile_pics', filename=profile_pic) if profile_pic and profile_pic != 'pfp.jpg' else url_for('static', filename='pfp.jpg') }}"
                                            class="pfp img-notif-request">
                                    </a>
                                    <div class="notif-details">
                                        <div class="notif-text">
                                            <span style="font-weight: 600;">
                                                <a href="{{ url_for('profile', user_id=actor_id) }}">{{ display_name
                                                    }}</a>
                                            </span>
                                            {% if action == 'like' %}
                                            liked your <a href="{{ url_for('view_post', image_id=image_id) }}"><span
                                                    style="font-weight: 600; cursor: pointer;">post</span></a>.
                                            {% elif action == 'comment' %}
                                            commented on your <a
                                                href="{{ url_for('view_post', image_id=image_id) }}"><span
                                                    style="font-weight: 600; cursor: pointer;">post</span></a>.
                                            {% elif action == 'collab_check' %}
                                            found you as a
                                            <span class="open-modal"
                                                onclick='openMatchModal({{ actor_details[actor_id] | tojson | safe }})'
                                                style="font-weight: 600; cursor: pointer;">
                                                match</span>.
                                            {% endif %}
                                        </div>
                                        <div class="notif-date">
                                            {{ created_at.strftime('%b') }} {{ created_at.day }}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="notifs-empty">
                                    <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                                    <div class="oops">Oops!</div>
                                    <div class="nothing">Nothing to show here at the moment.</div>
                                </div>
                                {% endif %}
                            </div>

                            <div class="line-alerts"></div>

                            <div class="requests" id="requests-tablet">
                                <div class="requests-title">Requests</div>

                                {% if requests %}
                                {% for request_id, sender_id, first_name, last_name, created_at in requests %}
                                <div class="request-bar" id="request-{{ request_id }}">
                                    <a href="{{ url_for('profile', user_id=sender_id) }}">
                                        <img src="../static/pfp.jpg" class="pfp img-notif-request">
                                    </a>

                                    <div class="request-details">
                                        <div class="request-text">
                                            <span style="font-weight: 600;">
                                                <a href="{{ url_for('profile', user_id=sender_id) }}">
                                                    {{ first_name }} {{ last_name }}
                                                </a>
                                            </span> sent you a friend request.
                                        </div>
                                        <div class="request-date">
                                            {{ created_at.strftime('%b') }} {{ created_at.day }}
                                        </div>
                                        <!--AL-->
                                        <div class="request-icons">
                                            <button type="button" class="circled-icon-1"
                                                onclick="handleRequest({{ request_id }}, 'reject')" {% if not verified
                                                %}disabled{% endif %}>
                                                <span class="material-symbols-outlined close-symbol">close</span>
                                            </button>

                                            <button type="button" class="circled-icon-2"
                                                onclick="handleRequest({{ request_id }}, 'accept')" {% if not verified
                                                %}disabled{% endif %}>
                                                <span class="material-symbols-outlined check-symbol">check</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="notifs-empty">
                                    <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                                    <div class="oops">Oops!</div>
                                    <div class="nothing">Nothing to show here at the moment.</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="backdrop" id="backdrop-tablet"></div>





                    <div class="pfp-frame-wrapper">
                        <img src="{{ profile_pic_url }}" class="pfp right" id="pfp3">
                        <div class="frame3" id="frame3">
                            <div class="frame-username">
                                <a href="{{ url_for('profile', user_id=current_user.id) }}">
                                    {{ current_user.first_name }} {{ current_user.last_name }}
                                </a>
                            </div>
                            <div class="line"></div>
                            <a href="{{ url_for('saved') }}">
                                <div class="saved">Saved</div>
                            </a>
                            <a href="{{ url_for('settings') }}">
                                <div class="settings">Settings</div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mobile-only">
                <a href="{{ url_for('feed') }}"><img id="logo" src="..\static\Logo.png" class="logo"></a>
                <div class="button-pfp-wrapper">
                    <!-- 🔍 Mobile Search Toggle Button -->
                    <button id="mobileSearchToggle" class="search-button hide-desktop">
                        <span class="material-symbols-outlined search-symbol">search</span>
                    </button>

                    <!-- 🔍 Mobile Search Overlay -->
                    <div id="mobileSearchOverlay" class="mobile-search-overlay">
                        <form class="search-wrapper mobile-search-bar" action="{{ url_for('search_results') }}"
                            method="GET">
                            <button type="button" id="closeMobileSearch" class="search-button">
                                <span class="material-symbols-outlined search-symbol">arrow_back</span>
                            </button>
                            <input id="mobileSearchInput" class="search" type="text" name="query" placeholder="Search"
                                required>
                            <button class="search-button" type="submit">
                                <span class="material-symbols-outlined search-symbol">search</span>
                            </button>
                        </form>
                    </div>

                    <!-- Notification wrapper -->
                    <div class="notifs-wrapper mobile-wrapper">
                        <button class="notifs-button">
                            <span class="material-symbols-outlined notifs-symbol">notifications</span>
                        </button>

                        <!-- Dropdown (initially hidden, shown via JS by adding 'dropdown-visible') -->
                        <div class="notifs-requests-dropdown" data-group="notifications" id="dropdown-mobile">
                            <div class="notifs" id="notifs-tablet">
                                <div class="notifs-title">Notifs</div>

                                {% if notifications %}
                                {% for display_name, action, image_id, created_at, actor_id, profile_pic, id in
                                notifications %}
                                <div class="notif-bar">
                                    <a href="{{ url_for('profile', user_id=actor_id) }}">
                                        <img src="{{ url_for('profile_pics', filename=profile_pic) if profile_pic and profile_pic != 'pfp.jpg' else url_for('static', filename='pfp.jpg') }}"
                                            class="pfp img-notif-request">
                                    </a>
                                    <div class="notif-details">
                                        <div class="notif-text">
                                            <span style="font-weight: 600;">
                                                <a href="{{ url_for('profile', user_id=actor_id) }}">{{ display_name
                                                    }}</a>
                                            </span>
                                            {% if action == 'like' %}
                                            liked your <a href="{{ url_for('view_post', image_id=image_id) }}"><span
                                                    style="font-weight: 600; cursor: pointer;">post</span></a>.
                                            {% elif action == 'comment' %}
                                            commented on your <a
                                                href="{{ url_for('view_post', image_id=image_id) }}"><span
                                                    style="font-weight: 600; cursor: pointer;">post</span></a>.
                                            {% elif action == 'collab_check' %}
                                            found you as a
                                            <span class="open-modal"
                                                onclick='openMatchModal({{ actor_details[actor_id] | tojson | safe }})'
                                                style="font-weight: 600; cursor: pointer;">
                                                match</span>.
                                            {% endif %}
                                        </div>
                                        <div class="notif-date">
                                            {{ created_at.strftime('%b') }} {{ created_at.day }}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="notifs-empty">
                                    <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                                    <div class="oops">Oops!</div>
                                    <div class="nothing">Nothing to show here at the moment.</div>
                                </div>
                                {% endif %}
                            </div>

                            <div class="line-alerts"></div>

                            <div class="requests" id="requests-tablet">
                                <div class="requests-title">Requests</div>

                                {% if requests %}
                                {% for request_id, sender_id, first_name, last_name, created_at in requests %}
                                <div class="request-bar" id="request-{{ request_id }}">
                                    <a href="{{ url_for('profile', user_id=sender_id) }}">
                                        <img src="../static/pfp.jpg" class="pfp img-notif-request">
                                    </a>

                                    <div class="request-details">
                                        <div class="request-text">
                                            <span style="font-weight: 600;">
                                                <a href="{{ url_for('profile', user_id=sender_id) }}">
                                                    {{ first_name }} {{ last_name }}
                                                </a>
                                            </span> sent you a friend request.
                                        </div>
                                        <div class="request-date">
                                            {{ created_at.strftime('%b') }} {{ created_at.day }}
                                        </div>
                                        <div class="request-icons">
                                            <button type="button" class="circled-icon-1"
                                                onclick="handleRequest({{ request_id }}, 'reject')" {% if not verified
                                                %}disabled{% endif %}>
                                                <span class="material-symbols-outlined close-symbol">close</span>
                                            </button>

                                            <button type="button" class="circled-icon-2"
                                                onclick="handleRequest({{ request_id }}, 'accept')" {% if not verified
                                                %}disableda{% endif %}>
                                                <span class="material-symbols-outlined check-symbol">check</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="notifs-empty">
                                    <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                                    <div class="oops">Oops!</div>
                                    <div class="nothing">Nothing to show here at the moment.</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="backdrop" id="backdrop-mobile"></div>

                    <div class="pfp-frame-wrapper">
                        <img src="{{ profile_pic_url }}" class="pfp right" id="pfp4">
                        <div class="frame4" id="frame4">
                            <div class="frame-username">
                                <a href="{{ url_for('profile', user_id=current_user.id) }}">
                                    {{ current_user.first_name }} {{ current_user.last_name }}
                                </a>
                            </div>
                            <div class="line"></div>
                            <a href="{{ url_for('saved') }}">
                                <div class="saved">Saved</div>
                            </a>
                            <a href="{{ url_for('settings') }}">
                                <div class="settings">Settings</div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <main>
                {% block content %}{% endblock %}
            </main>
            <div class="right-sidebar-container">
                <div class="right-sidebar">
                    <div class="pfp-frame-wrapper">
                        <img src="{{ profile_pic_url }}" class="pfp right" id="pfp" />
                        <div class="frame2" id="frame2">
                            <div class="frame-username">
                                <a href="{{ url_for('profile', user_id=current_user.id) }}">
                                    {{ current_user.first_name }} {{ current_user.last_name }}
                                </a>
                            </div>
                            <div class="line"></div>
                            <a href="{{ url_for('saved') }}">
                                <div class="saved">Saved</div>
                            </a>
                            <a href="{{ url_for('settings') }}">
                                <div class="settings">Settings</div>
                            </a>
                        </div>
                    </div>
                    <div class="notifs" id="notifs">
                        <div class="notifs-title">
                            Notifs
                        </div>
                        {% if notifications %}
                        {% for display_name, action, image_id, created_at, actor_id, profile_pic, notification_id in
                        notifications %}
                        <div class="notif-bar" id="notif-{{ notification_id }}">
                            <a href="{{ url_for('profile', user_id=actor_id) }}"><img
                                    src="{{ url_for('profile_pics', filename=profile_pic) if profile_pic and profile_pic != 'pfp.jpg' else url_for('static', filename='pfp.jpg') }}"
                                    class="pfp img-notif-request"></a>
                            <div class="notif-details">
                                <div class="notif-text">
                                    <span style="font-weight: 600;">
                                        <a href="{{ url_for('profile', user_id=actor_id) }}">{{ display_name
                                            }}</a>
                                    </span>
                                    {% if action == 'like' %}
                                    liked your <a href="{{ url_for('view_post', image_id=image_id) }}"><span
                                            style="font-weight: 600; cursor: pointer;">post</span></a>.
                                    {% elif action == 'comment' %}
                                    commented on your <a href="{{ url_for('view_post', image_id=image_id) }}"><span
                                            style="font-weight: 600; cursor: pointer;">post</span></a>.
                                    {% elif action == 'collab_check' %}
                                    found you as a
                                    <span class="open-modal"
                                        onclick='openMatchModal({{ actor_details[actor_id] | tojson | safe }})'
                                        style="font-weight: 600; cursor: pointer;">
                                        match</span>.
                                    {% endif %}
                                </div>
                                <div class="notif-date">
                                    {{ created_at.strftime('%b') }} {{ created_at.day }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="notifs-empty">
                            <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                            <div class="oops">Oops!</div>
                            <div class="nothing">Nothing to show here at the moment.</div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="requests" id="requests">
                        <div class="requests-title">
                            Requests
                        </div>
                        {% if requests %}
                        {% for request_id, sender_id, first_name, last_name, created_at in requests %}
                        <div class="request-bar" id="request-{{ request_id }}">
                            <a href="{{ url_for('profile', user_id=sender_id) }}"><img src="../static/pfp.jpg"
                                    class="pfp img-notif-request"></a>

                            <div class="request-details">
                                <div class="request-text">
                                    <span style="font-weight: 600;">
                                        <a href="{{ url_for('profile', user_id=sender_id) }}">
                                            {{ first_name }} {{ last_name }}
                                        </a>
                                    </span> sent you a friend request.
                                </div>
                                <div class="request-date">
                                    {{ created_at.strftime('%b') }} {{ created_at.day }}
                                </div>
                                <div class="request-icons">
                                    <button type="button" class="circled-icon-1"
                                        onclick="handleRequest({{ request_id }}, 'reject')" {% if not verified
                                        %}disabled{% endif %}>
                                        <span class="material-symbols-outlined close-symbol">close</span>
                                    </button>

                                    <button type="button" class="circled-icon-2"
                                        onclick="handleRequest({{ request_id }}, 'accept')" {% if not verified
                                        %}disableda{% endif %}>
                                        <span class="material-symbols-outlined check-symbol">check</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="notifs-empty">
                            <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                            <div class="oops">Oops!</div>
                            <div class="nothing">Nothing to show here at the moment.</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if show_profile_modal %}
            <div id="profileModal" class="modal show">
                <form method="POST" id="profileForm" action="/api/setup-profile">

                    <div class="overlaySetup" id="step-1">
                        <div class="overlay-content-setup">
                            <div class="overlay-title-setup">Setup</div>
                            <div class="div-setup" id="divSetup1">
                                <img src="..\static\pfp.jpg" class="pfpsetup1">
                                <div class="heading">Hello, {{ current_user.first_name }} {{ current_user.last_name }}!
                                </div>
                                <div class="subheading">Ready to setup your account?</div>
                                <button class="next-button" type="button" onclick="nextStep()">Next</button>
                            </div>
                        </div>
                    </div>

                    <div class="overlaySetup" id="step-2" style="display:none;">
                        <div class="overlay-content-setup">
                            <div class="overlay-title-setup">Setup</div>
                            <div class="div-setup" id="divSetup2">
                                <div class="heading">What is your role?</div>
                                <div class="subheading">Your role helps us personalize your experience.</div>
                                <input class="setup2-field" type="text" placeholder="ex. Graphic Designer" id="role"
                                    name="role" maxlength="100" required>
                                <div class="button-wrapper">
                                    <div class="partner-back" onclick="prevStep()">
                                        <span class="material-symbols-outlined lcs-symbol-back">arrow_back</span>
                                        <div class="partner-label-back">Back</div>
                                    </div>
                                    <button class="next-button" type="button" onclick="nextStep()">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overlaySetup" id="step-3" style="display:none;">
                        <div class="overlay-content-setup">
                            <div class="overlay-title-setup">Setup</div>
                            <div class="div-setup" id="divSetup3">
                                <div class="heading">Where are you located?</div>
                                <div class="subheading">Show us where your ideas come to life.</div>
                                <div class="left-align">
                                    <div class="label">Country</div>
                                    <div class="label-wrapper">
                                        <select class="location" id="country" name="country" required>
                                            <option value="">Select your country</option>
                                            {% for country in countries %}
                                            <option value="{{ country.iso2 }}" data-iso="{{ country.iso2 }}" {% if
                                                user.country|trim|lower==country.iso2|trim|lower %}selected{% endif %}>
                                                {{ country.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <span class="material-symbols-outlined down-symbol">arrow_drop_down</span>
                                    </div>
                                    <div class="label">Region or Province</div>
                                    <div class="label-wrapper">
                                        <select class="location" id="state" name="state" required>
                                            <option value="">Select your region or province</option>
                                            {% for state in states if state.country_code == user.country %}
                                            <option value="{{ state.state_code }}" {% if state.state_code==user.state
                                                %}selected{% endif %}>
                                                {{ state.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <span class="material-symbols-outlined down-symbol">arrow_drop_down</span>
                                    </div>
                                    <div class="label">City</div>
                                    <div class="label-wrapper">
                                        <select class="location" id="city" name="city" required>
                                            <option value="">Select your city</option>
                                        </select>
                                        <span class="material-symbols-outlined down-symbol">arrow_drop_down</span>
                                    </div>
                                </div>
                                <div class="button-wrapper">
                                    <div class="partner-back" onclick="prevStep()">
                                        <span class="material-symbols-outlined lcs-symbol-back">arrow_back</span>
                                        <div class="partner-label-back">Back</div>
                                    </div>
                                    <button class="next-button" type="button" onclick="nextStep()">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overlaySetup" id="step-4" style="display:none;">
                        <div class="overlay-content-setup">
                            <div class="overlay-title-setup">Setup</div>
                            <div class="div-setup" id="divSetup4">
                                <div class="heading">What are your skills?</div>
                                <div class="subheading">Tell us what you’re good at—select all that apply.</div>
                                <div class="checkbox-grid">
                                    {% for category in categories %}
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="skills" value="{{ category }}">
                                        {{ category }}
                                    </label>
                                    {% endfor %}
                                    <!--<a href="#" class="view-more">View all fields...</a>-->
                                </div>
                                <div class="button-wrapper">
                                    <div class="partner-back" onclick="prevStep()">
                                        <span class="material-symbols-outlined lcs-symbol-back">arrow_back</span>
                                        <div class="partner-label-back">Back</div>
                                    </div>
                                    <button class="next-button" type="button" onclick="nextStep()">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overlaySetup" id="step-5" style="display:none;">
                        <div class="overlay-content-setup">
                            <div class="overlay-title-setup">Setup</div>
                            <div class="div-setup" id="divSetup5">
                                <div class="heading">What are your preferences?</div>
                                <div class="subheading">Tell us your design vibe—select all that apply.</div>
                                <div class="checkbox-grid">
                                    {% for category in categories %}
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="preferences" value="{{ category }}">
                                        {{ category }}
                                    </label>
                                    {% endfor %}
                                    <!--<a href="#" class="view-more">View all fields...</a>-->
                                </div>
                                <div class="button-wrapper">
                                    <div class="partner-back" onclick="prevStep()">
                                        <span class="material-symbols-outlined lcs-symbol-back">arrow_back</span>
                                        <div class="partner-label-back">Back</div>
                                    </div>
                                    <button class="next-button" type="button" onclick="nextStep()">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overlaySetup" id="step-6" style="display:none;">
                        <div class="overlay-content-setup">
                            <div class="overlay-title-setup">Setup</div>
                            <div class="div-setup" id="divSetup6">
                                <div class="heading">What is your experience level?</div>
                                <div class="subheading">Select your level, whether you're just starting or a pro.</div>
                                <div class="left-align">
                                    {% for value, label in experience_levels %}
                                    <label class="radio-item">
                                        <input type="radio" name="experience_level" value="{{ value }}" required>{{
                                        label }}
                                    </label>
                                    {% endfor %}
                                </div>
                                <div class="button-wrapper">
                                    <div class="partner-back" onclick="prevStep()">
                                        <span class="material-symbols-outlined lcs-symbol-back">arrow_back</span>
                                        <div class="partner-label-back">Back</div>
                                    </div>
                                    <button class="next-button" type="button" onclick="nextStep()">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overlaySetup" id="step-7" style="display:none;">
                        <div class="overlay-content-setup">
                            <div class="overlay-title-setup">Setup</div>
                            <div class="div-setup" id="divSetup7">
                                <div class="heading">Link your external accounts.</div>
                                <div class="subheading">Let your profiles speak for you.</div>
                                <table class="social-table">
                                    <tr>
                                        <td><label for="facebook">Facebook</label></td>
                                        <td>
                                            <input type="url" id="facebook" name="facebook"
                                                placeholder="https://facebook.com/yourprofile">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><label for="instagram">Instagram</label></td>
                                        <td>
                                            <input type="url" id="instagram" name="instagram"
                                                placeholder="https://instagram.com/yourprofile">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><label for="x">X</label></td>
                                        <td>
                                            <input type="url" id="x" name="x" placeholder="https://x.com/yourprofile">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><label for="linkedin">LinkedIn</label></td>
                                        <td>
                                            <input type="url" id="linkedin" name="linkedin"
                                                placeholder="https://linkedin.com/in/yourprofile">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><label for="telegram">Telegram</label></td>
                                        <td>
                                            <input type="url" id="telegram" name="telegram"
                                                placeholder="https://t.me/yourusername">
                                        </td>
                                    </tr>
                                </table>
                                <div class="button-wrapper">
                                    <div class="partner-back" onclick="prevStep()">
                                        <span class="material-symbols-outlined lcs-symbol-back">arrow_back</span>
                                        <div class="partner-label-back">Back</div>
                                    </div>
                                    <button class="next-button" type="submit">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 1: Skills
                <div class="form-step" id="step-1">
                    <h2>Your Skills</h2>
                    {% for category in categories %}
                    <label>
                        <input type="checkbox" name="skills" value="{{ category }}">
                        {{ category }}
                    </label><br>
                    {% endfor %}
                    <button type="button" onclick="nextStep()">Next</button>
                </div>-->

                    <!-- Step 2: Preferences
                <div class="form-step" id="step-2" style="display:none;">
                    <h2>Your Preferences</h2>
                    {% for category in categories %}
                    <label>
                        <input type="checkbox" name="preferences" value="{{ category }}">
                        {{ category }}
                    </label><br>
                    {% endfor %}
                    <button type="button" onclick="prevStep()">Previous</button>
                    <button type="button" onclick="nextStep()">Next</button>
                </div> -->

                    <!-- Step 3: Experience
                <div class="form-step" id="step-3" style="display:none;">
                    <h2>Experience Level</h2>
                    <label for="experience_level">Select your level:</label><br>
                    <select name="experience_level" id="experience_level" required>
                        {% for value, label in experience_levels %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select><br><br>
                    <button type="button" onclick="prevStep()">Previous</button>
                    <button type="button" onclick="nextStep()">Next</button>
                </div> -->

                    <!-- Step 4: Role
                <div class="form-step" id="step-4" style="display:none;">
                    <h2>Your Role</h2>
                    <input type="text" id="role" name="role" maxlength="100" required><br><br>
                    <button type="button" onclick="prevStep()">Previous</button>
                    <button type="button" onclick="nextStep()">Next</button>
                </div> -->

                    <!-- Step 5: Location
                <div class="form-step" id="step-5" style="display:none;">
                    <h2>Location</h2>
                    <label for="country">Country:</label><br>
                    <select id="country" name="country" required>
                        <option value="">Select Country</option>
                        {% for country in countries %}
                        <option value="{{ country.name }}" data-iso="{{ country.iso2 }}">{{ country.name }}</option>
                        {% endfor %}
                    </select><br><br>

                    <label for="state">State/Region:</label><br>
                    <select id="state" name="state" required>
                        <option value="">Select State</option>
                    </select><br><br>

                    <label for="city">City:</label><br>
                    <select id="city" name="city" required>
                        <option value="">Select City</option>
                    </select><br><br>

                    <button type="button" onclick="prevStep()">Previous</button>
                    <button type="button" onclick="nextStep()">Next</button>
                </div> -->

                    <!-- Step 6: Social Links
                <div class="form-step" id="step-6" style="display:none;">
                    <h2>Social Media Links</h2>
                    <input type="url" id="facebook" name="facebook"
                        placeholder="https://facebook.com/yourprofile"><br><br>
                    <input type="url" id="instagram" name="instagram"
                        placeholder="https://instagram.com/yourprofile"><br><br>
                    <input type="url" id="x" name="x" placeholder="https://x.com/yourprofile"><br><br>
                    <input type="url" id="linkedin" name="linkedin"
                        placeholder="https://linkedin.com/in/yourprofile"><br><br>
                    <input type="url" id="telegram" name="telegram" placeholder="https://t.me/yourusername"><br><br>

                    <button type="button" onclick="prevStep()">Previous</button>
                    <button type="submit">Save Profile</button>
                </div> -->
                </form>
            </div>
            {% endif %}
        </div>

        <div id="reportModal" class="modal" style="display: none;">
            <div class="modal-content">
                <button class="close-icon" onclick="closeReportModal()">
                    <span class="material-symbols-outlined overlay-close-symbol">close</span>
                </button>
                <div class="overlay-title">Report</div>
                <div class="heading" style="text-align: center;">Something not right?</div>
                <div class="subheading" style="text-align: center;">Let us know why you’re reporting this post.</div>
                <form id="reportForm" style="padding: 0 48px;">
                    <!-- Hidden field to store image ID -->
                    <input type="hidden" name="image_id" id="reportImageId">
                    <!-- Reasons with checkboxes -->
                    <div class="report-reasons">
                        <label class="checkbox-item">
                            <input type="checkbox" name="reason" value="Spam">
                            <span class="report-label">Spam or misleading content</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="reason" value="Inappropriate">
                            <span class="report-label">Inappropriate or offensive material</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="reason" value="Hate Speech">
                            <span class="report-label">Hate speech or abusive language</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="reason" value="Copyright">
                            <span class="report-label">Copyright infringement</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="reason" value="Other">
                            <span class="report-label">Other</span>
                        </label>
                    </div>

                    <!-- Buttons -->
                    <div class="match-button-wrapper" style="margin-bottom: 24px;">
                        <button type="button" class="browse-button" onclick="closeReportModal()">Cancel</button>
                        <button type="submit" class="match-button">Submit</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="matchModal" class="modal" style="display: none;">
            <!-- Debug output -->
            {% if actor_id in actor_details %}
            <pre>{{ actor_details[actor_id] | tojson(indent=2) }}</pre>
            {% endif %}

            <div class="modal-content">
                <!-- Step 1 -->
                <div class="modal-step" id="match-step-1">
                    <button class="close-icon btn-cancel" onclick="closeMatchModal()">
                        <span class="material-symbols-outlined overlay-close-symbol">close</span>
                    </button>
                    <div class="overlay-title">Match</div>
                    <div class="padding-match">
                        <div class="div-setup">
                            <img id="match-pfp-step1" class="pfpsetup1">
                            <div class="heading">
                                <span id="match-username" style="font-weight: 600;"></span> found you as a match.
                            </div>
                            <div class="subheading">You're now connected, unless you say otherwise.</div>
                            <button class="next-button" onclick="showMatchStep(2)">Next</button>
                        </div>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="modal-step" id="match-step-2" style="display: none;">
                    <button class="close-icon btn-cancel" onclick="closeMatchModal()">
                        <span class="material-symbols-outlined overlay-close-symbol">close</span>
                    </button>
                    <div class="overlay-title">Match</div>
                    <div class="padding-match">
                        <div class="match-wrapper">
                            <img id="match-pfp-step2" class="pfpsetup1">

                            <div class="match-card">
                                <div class="username-profile" id="match-fullname"></div>
                                <div class="icon-title-wrapper">
                                    <span class="material-symbols-outlined person-symbol">person</span>
                                    <div class="title" id="match-role"></div>
                                </div>
                                <div class="icon-title-wrapper">
                                    <span class="material-symbols-outlined world-symbol">public</span>
                                    <div class="location-profile" id="match-location"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Skills -->
                        <div class="info-sandp">
                            <div class="info-title-match">Skills</div>
                            <div class="info-content-match" id="match-skills"></div>
                        </div>

                        <!-- Preferences -->
                        <div class="info-sandp">
                            <div class="info-title-match">Preferences</div>
                            <div class="info-content-match" id="match-preferences"></div>
                        </div>

                        <!-- Experience Level -->
                        <div class="info-sandp">
                            <div class="info-title-match">Experience Level</div>
                            <div class="info-content-match">
                                <div class="info-one-match" id="match-experience" style="margin-bottom: 36px;"></div>
                            </div>
                        </div>

                        <div class="button-wrapper">
                            <div class="partner-back-match" onclick="showMatchStep(1)">
                                <span class="material-symbols-outlined lcs-symbol-back">arrow_back</span>
                                <div class="partner-label-back">Back</div>
                            </div>
                            <div class="match-button-wrapper">
                                <button id="decline-match" class="browse-button">Decline Match</button>
                                <button class="next-button" onclick="showMatchStep(3)">Next</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="modal-step" id="match-step-3" style="display: none;">
                    <button class="close-icon btn-cancel" onclick="closeMatchModal()">
                        <span class="material-symbols-outlined overlay-close-symbol">close</span>
                    </button>
                    <div class="overlay-title">Match</div>
                    <div class="padding-match">
                        <div class="share-wrapper">
                            <div class="share-via">Reach out via</div>
                            <div class="icon-grid">
                                <a href="#" target="_blank" rel="noopener noreferrer"><img src="../static/fb.png"
                                        class="fb"></a>
                                <a href="#" target="_blank" rel="noopener noreferrer"><img src="../static/ig.png"
                                        class="ig"></a>
                                <a href="#" target="_blank" rel="noopener noreferrer"><img src="../static/x.png"
                                        class="x"></a>
                                <a href="#" target="_blank"><img src="../static/gmail.png" class="gmail"></a>
                                <a href="#" target="_blank" rel="noopener noreferrer"><img src="../static/linkedin.png"
                                        class="linkedin"></a>
                                <a href="#"><img src="../static/telegram.png" class="telegram"></a>
                            </div>
                        </div>
                        <div class="button-wrapper">
                            <div class="partner-back" onclick="showMatchStep(2)">
                                <span class="material-symbols-outlined lcs-symbol-back">arrow_back</span>
                                <div class="partner-label-back">Back</div>
                            </div>
                            <button onclick="closeMatchModal()" class="next-button">Done</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <ul class="mobile-nav">
            <li><a href="{{ url_for('feed') }}">
                    <span
                        class="material-symbols-outlined {% if current_page == 'feed' %}current{% endif %}">newspaper</span>
                </a></li>
            <li><a href="{{ url_for('pairup') }}">
                    <span
                        class="material-symbols-outlined {% if current_page in ['pairup', 'match'] %}current{% endif %}">group</span>
                </a></li>
            <li><a href="{{ url_for('profile', user_id=current_user.id) }}">
                    <span
                        class="material-symbols-outlined {% if current_page == 'profile' and is_own_profile %}current{% endif %}">person</span>
                </a></li>
            <li><a href="{{ url_for('logout') }}">
                    <span class="material-symbols-outlined">logout</span>
                </a></li>
        </ul>

        <script>

            window.addEventListener('load', function () {
                document.body.classList.remove('loading');       // show app
                document.getElementById('loader').style.display = 'none';  // hide loader
            });

            let reportImageId = null;

            function openReportModal(imageId, event) {
                if (event) event.preventDefault();

                const modal = document.getElementById("reportModal");
                modal.style.display = "flex";
                document.body.style.overflow = "hidden";  // lock scrolling

                // ✅ Assign imageId to hidden input
                document.getElementById('reportImageId').value = imageId;
            }

            function closeReportModal() {
                const modal = document.getElementById('reportModal');
                modal.style.display = 'none';
                document.body.style.overflow = "";  // reset it
            }

            document.getElementById('reportForm').addEventListener('submit', function (e) {
                e.preventDefault();

                const form = this;
                const formData = new FormData(form);

                fetch('/report', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                console.error("Server responded with error:", response.status, text);
                                throw new Error(`Status ${response.status}: ${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        const imageId = formData.get('image_id');
                        const postElement = document.getElementById(`image-${imageId}`);
                        if (postElement) postElement.style.display = 'none';
                        closeReportModal();
                    })
                    .catch(error => {
                        console.error("Final catch:", error);
                        alert("An error occurred while submitting your report.");
                    });
            });

            const sections = Array.from(document.querySelectorAll('.nav-section'));
            let currentIndex = 0;

            function showSection(index) {
                sections.forEach((sec, i) => {
                    sec.classList.toggle('active', i === index);
                });
            }

            sections.forEach((section) => {
                section.addEventListener('click', function (e) {
                    const clickX = e.clientX - this.getBoundingClientRect().left;
                    const width = this.offsetWidth;

                    if (clickX < width / 2) {
                        // Clicked on left side - move to previous
                        currentIndex = (currentIndex - 1 + sections.length) % sections.length;
                    } else {
                        // Clicked on right side - move to next
                        currentIndex = (currentIndex + 1) % sections.length;
                    }

                    showSection(currentIndex);
                });
            });




            window.handleFriendship = function (userId, action, buttonElement) {
                fetch(`/${action}/${userId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include'
                })
                    .then(res => res.json())
                    .then(data => {
                        if (!data.success) {
                            alert(data.message || 'Something went wrong.');
                            return;
                        }

                        // Unfriend or Cancel Request → Reset to Befriend
                        if (action === 'unfriend' || action === 'cancel_request') {
                            buttonElement.textContent = 'Befriend';
                            buttonElement.onclick = () => handleFriendship(userId, 'send_request', buttonElement);
                        }

                        // Send Request → Check if there's already a pending request from the other user
                        else if (action === 'send_request') {
                            if (data.request_id && data.status === 'incoming_pending') {
                                // Replace button with confirm/decline UI
                                buttonElement.outerHTML = `
                    <div class="response-wrapper" id="request-${data.request_id}">
                        <button type="button" class="follow-button-profile no-margin"
                            onclick="respondToRequest(${data.request_id}, 'accept', this)" data-userid="${userId}">
                            Confirm
                        </button>
                        <button type="button" class="follow-button-profile-secondary no-margin"
                            onclick="respondToRequest(${data.request_id}, 'reject', this)" data-userid="${userId}">
                            Decline
                        </button>
                    </div>
                `;
                            } else {
                                // Normal pending request
                                buttonElement.textContent = 'Cancel Request';
                                buttonElement.onclick = () => handleFriendship(userId, 'cancel_request', buttonElement);
                            }
                        }
                    })
                    .catch(err => {
                        console.error('Friendship error:', err);
                        alert('Error performing action.');
                    });
            };




            window.hidePost = function (imageId) {
                fetch(`/hide_post/${imageId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const post = document.querySelector(`[data-image-id="${imageId}"]`);
                            if (post) post.remove();
                        } else {
                            alert('Failed to hide post: ' + data.message);
                        }
                    })
                    .catch(err => {
                        alert('Error hiding post: ' + err);
                    });
            };

            let currentStep = 1;
            const totalSteps = 7;

            function showStep(step) {
                for (let i = 1; i <= totalSteps; i++) {
                    const el = document.getElementById('step-' + i);
                    if (el) el.style.display = (i === step) ? 'flex' : 'none';
                }
            }

            function nextStep() {
                if (currentStep < totalSteps) {
                    currentStep++;
                    showStep(currentStep);
                }
            }

            function prevStep() {
                if (currentStep > 1) {
                    currentStep--;
                    showStep(currentStep);
                }
            }


            function deleteImage(imageId) {
                if (!confirm("Are you sure you want to delete this image?")) return;

                fetch(`/delete/${imageId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include' // Include session cookies
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.error || "Failed to delete image.");
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        const imageElement = document.getElementById(`image-${imageId}`);
                        if (imageElement) {
                            imageElement.remove();
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting image:', error);
                        alert(error.message || "An error occurred.");
                    });
            }


            function deleteComment(commentId) {
                if (!confirm("Are you sure you want to delete this comment?")) return;

                fetch(`/comment/delete/${commentId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.error || "Failed to delete comment.");
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        const commentElement = document.getElementById(`comment-${commentId}`);
                        if (commentElement) {
                            commentElement.remove();
                        }

                        // Only check scroll on comment divs
                        checkCommentScrollbar();
                    })
                    .catch(error => {
                        console.error('Error deleting comment:', error);
                        alert(error.message || "An error occurred.");
                    });
            }

            // Check scrollbar only on scrollableDiv and comment section
            function checkCommentScrollbar() {
                const imageInput = document.getElementById('image');
                const div = document.getElementById('scrollableDiv');
                const commentDivs = document.querySelectorAll('[id^="scrollableDivComments"]');

                if (imageInput && div) {
                    div.classList.remove('no-scroll', 'has-scroll');
                    if (imageInput.files.length > 0) {
                        div.classList.add('has-scroll');
                    } else {
                        div.classList.add('no-scroll');
                    }
                }

                commentDivs.forEach(el => {
                    el.classList.remove('no-scroll', 'has-scroll');
                    if (el.scrollHeight > el.clientHeight) {
                        el.classList.add('has-scroll');
                    } else {
                        el.classList.add('no-scroll');
                    }
                });
            }



            function openImageModal(src) {
                const modal = document.getElementById("imageModal");
                const img = document.getElementById("modalImage");
                img.src = src;
                modal.classList.add("show");

                // Freeze background scroll
                const scrollY = window.scrollY;
                document.body.style.top = `-${scrollY}px`;
                document.body.classList.add("no-scrolling");
                document.body.dataset.scrollY = scrollY; // save scroll position
            }

            function closeImageModal(event) {
                if (event.target.id === "imageModal" || event.target.classList.contains("close-btn")) {
                    const modal = document.getElementById("imageModal");
                    modal.classList.remove("show");

                    // Unfreeze background scroll
                    const scrollY = parseInt(document.body.dataset.scrollY || "0");
                    document.body.classList.remove("no-scrolling");
                    document.body.style.top = "";
                    window.scrollTo(0, scrollY);
                }
            }

            const toggleBtn = document.getElementById('mobileSearchToggle');
            const overlay = document.getElementById('mobileSearchOverlay');
            const closeBtn = document.getElementById('closeMobileSearch');

            toggleBtn.addEventListener('click', () => {
                overlay.classList.add('show');
            });

            closeBtn.addEventListener('click', () => {
                overlay.classList.remove('show');
            });



            const desktopInput = document.getElementById('desktopSearchInput');
            const mobileInput = document.getElementById('mobileSearchInput');

            // 🔄 Keep both inputs in sync
            desktopInput.addEventListener('input', () => {
                mobileInput.value = desktopInput.value;
            });

            mobileInput.addEventListener('input', () => {
                desktopInput.value = mobileInput.value;
            });



            document.addEventListener('DOMContentLoaded', function () {

                let friendsScrollPosition = 0;

                function openFriendsModal() {
                    friendsScrollPosition = window.scrollY;
                    document.body.style.top = `-${friendsScrollPosition}px`;
                    document.body.classList.add('no-scrolling');

                    const overlay = document.getElementById('friendsModalOverlay');
                    if (overlay) overlay.style.display = 'flex';
                }

                function closeFriendsModal() {
                    const overlay = document.getElementById('friendsModalOverlay');
                    if (overlay) overlay.style.display = 'none';

                    document.body.classList.remove('no-scrolling');
                    document.body.style.top = '';
                    window.scrollTo(0, friendsScrollPosition);
                }

                const openFriendsButton = document.getElementById('openFriendsButton');
                const closeFriendsButton = document.getElementById('closeFriendsButton');
                const friendsModalOverlay = document.getElementById('friendsModalOverlay');

                if (openFriendsButton) {
                    openFriendsButton.addEventListener('click', openFriendsModal);
                }

                if (closeFriendsButton) {
                    closeFriendsButton.addEventListener('click', closeFriendsModal);
                }

                if (friendsModalOverlay) {
                    friendsModalOverlay.addEventListener('click', (event) => {
                        if (event.target === event.currentTarget) {
                            closeFriendsModal();
                        }
                    });
                }


                document.querySelectorAll('.link-wrapper').forEach(wrapper => {
                    const button = wrapper.querySelector('.link-button');
                    const linkDiv = wrapper.querySelector('.link');
                    const icon = button.querySelector('.link-symbol');

                    button.addEventListener('click', () => {
                        const textToCopy = linkDiv.textContent.trim();

                        navigator.clipboard.writeText(textToCopy)
                            .then(() => {
                                icon.classList.add('copied');
                                setTimeout(() => {
                                    icon.classList.remove('copied');
                                }, 1500);
                            })
                            .catch(err => {
                                console.error('Copy failed', err);
                                alert('Failed to copy link');
                            });
                    });
                });

                function resolveTheme(value) {
                    if (value === "dark" || value === "light") return value;
                    if (value === "auto") {
                        return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
                    }
                    return "light";
                }

                // 1. Read saved setting and apply it
                const savedThemeSetting = localStorage.getItem("theme") || "auto";
                const resolvedTheme = resolveTheme(savedThemeSetting);
                document.documentElement.setAttribute("data-theme", resolvedTheme);

                // 2. Pre-check matching radio
                const radios = document.querySelectorAll('input[name="theme_mode"]');
                radios.forEach(radio => {
                    if (radio.value === savedThemeSetting) {
                        radio.checked = true;
                    }
                });

                // 3. Handle change
                radios.forEach(radio => {
                    radio.addEventListener("change", () => {
                        const selectedValue = radio.value;
                        const newTheme = resolveTheme(selectedValue);
                        document.documentElement.setAttribute("data-theme", newTheme);
                        localStorage.setItem("theme", selectedValue);
                    });
                });

                const logo = document.getElementById('logo');
                const loaderLogo = document.getElementById('loader-logo');

                function updateLogosByTheme(theme) {
                    if (logo) {
                        logo.src = theme === "dark"
                            ? "/static/Logo-light.png"
                            : "/static/Logo.png";
                    }

                    if (loaderLogo) {
                        loaderLogo.src = theme === "dark"
                            ? "../static/Logo-light-compressed.png"
                            : "../static/Logo-compressed.png";
                    }
                }

                // Initial update
                updateLogosByTheme(resolvedTheme);

                // System theme change listener (only if theme is set to "auto")
                const media = window.matchMedia('(prefers-color-scheme: dark)');
                media.addEventListener('change', () => {
                    const currentSetting = localStorage.getItem("theme") || "auto";
                    if (currentSetting === "auto") {
                        const newResolvedTheme = resolveTheme("auto");
                        document.documentElement.setAttribute("data-theme", newResolvedTheme);
                        updateLogosByTheme(newResolvedTheme);
                    }
                });

                function showMatchStep(step) {
                    document.querySelectorAll('.modal-step').forEach(stepDiv => stepDiv.style.display = 'none');
                    document.getElementById(`match-step-${step}`).style.display = 'block';
                }

                function declineMatch() {
                    alert('You have declined the match.');
                    closeModal();
                }

                function closeModal() {
                    document.getElementById('matchModal').style.display = 'none';
                }

                // Expose to global scope so inline HTML can access them
                window.showMatchStep = showMatchStep;
                window.declineMatch = declineMatch;
                window.closeModal = closeModal;
                window.openMatchModal = openMatchModal; // make sure it's global


                document.querySelectorAll('.delete-match').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const otherUserId = this.dataset.id;

                        fetch('/decline_match', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ other_user_id: otherUserId })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.message) {
                                    // Remove the entire match entry from the DOM
                                    this.closest('.profile-more-wrapper-pairup').remove();
                                } else {
                                    alert('Error: ' + (data.error || 'Could not delete match.'));
                                }
                            });
                    });
                });

                document.getElementById('decline-match').addEventListener('click', function () {
                    const otherUserId = this.getAttribute('data-user-id');

                    fetch('/decline_match', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ other_user_id: otherUserId })
                    })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message || data.error);
                            document.getElementById('matchModal').style.display = 'none';
                            // Optionally remove or gray out the notification
                        });
                });

                window.handleRequest = function (requestId, action) {
                    const elements = document.querySelectorAll(`#request-${requestId}`);
                    console.log(`Attempting to ${action} request with ID: ${requestId}`);
                    console.log('Target elements:', elements);

                    fetch(`/${action}_request/${requestId}`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Parsed JSON:', data);
                            if (data.success) {
                                elements.forEach(el => {
                                    el.remove();
                                    console.log(`Removed element request-${requestId}`);
                                });

                                // Check if there are no more requests in both containers
                                const remainingRequests = document.querySelectorAll('.request-bar');
                                if (remainingRequests.length === 0) {
                                    const emptyStateHTML = `
                        <div class="notifs-empty">
                            <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                            <div class="oops">Oops!</div>
                            <div class="nothing">Nothing to show here at the moment.</div>
                        </div>
                    `;

                                    const containers = [document.querySelector('#requests'), document.querySelector('#requests-tablet')];

                                    containers.forEach(container => {
                                        if (container && !container.querySelector('.notifs-empty')) {
                                            container.insertAdjacentHTML('beforeend', emptyStateHTML);
                                            console.log('Inserted empty state into', container.id);
                                        }
                                    });
                                }
                            } else {
                                console.error("Error:", data.message || "Unknown error");
                                alert("Error: " + data.message);
                            }
                        })
                        .catch(error => {
                            console.error("AJAX error:", error);
                            alert("Something went wrong.");
                        });
                };




                const backdropMobile = document.getElementById('backdrop-mobile');
                const backdropTablet = document.getElementById('backdrop-tablet');
                let lastOpenedGroup = null;

                function getActiveBackdrop() {
                    return window.innerWidth <= 768 ? backdropMobile : backdropTablet;
                }

                function getInactiveBackdrop() {
                    return window.innerWidth <= 768 ? backdropTablet : backdropMobile;
                }

                function closeAllDropdowns() {
                    document.querySelectorAll('.notifs-requests-dropdown').forEach(dropdown => {
                        dropdown.classList.remove('dropdown-visible');
                    });
                    backdropMobile.style.display = 'none';
                    backdropTablet.style.display = 'none';
                    lastOpenedGroup = null;
                }

                function openDropdown(dropdown) {
                    closeAllDropdowns();
                    dropdown.classList.add('dropdown-visible');
                    getActiveBackdrop().style.display = 'block';
                    lastOpenedGroup = dropdown.dataset.group || null;
                }

                document.querySelectorAll('.notifs-wrapper').forEach(wrapper => {
                    const button = wrapper.querySelector('.notifs-button');
                    const dropdown = wrapper.querySelector('.notifs-requests-dropdown');

                    if (button && dropdown) {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const isVisible = dropdown.classList.contains('dropdown-visible');
                            if (!isVisible) {
                                openDropdown(dropdown);
                            } else {
                                closeAllDropdowns();
                            }
                        });
                    }
                });

                document.addEventListener('click', (e) => {
                    const clickedInside = Array.from(document.querySelectorAll('.notifs-wrapper'))
                        .some(wrapper => wrapper.contains(e.target));
                    if (!clickedInside) {
                        closeAllDropdowns();
                    }
                });

                backdropMobile.addEventListener('click', closeAllDropdowns);
                backdropTablet.addEventListener('click', closeAllDropdowns);

                // ✅ Resize logic — try reopening matching dropdown even if it's currently hidden
                window.addEventListener('resize', () => {
                    if (lastOpenedGroup) {
                        const dropdowns = document.querySelectorAll(`.notifs-requests-dropdown[data-group="${lastOpenedGroup}"]`);

                        for (const dropdown of dropdowns) {
                            // Check if it's in the currently visible layout
                            const wrapper = dropdown.closest('.notifs-wrapper');
                            if (wrapper && wrapper.offsetParent !== null) {
                                openDropdown(dropdown);
                                return;
                            }
                        }

                        // Fallback: close if none match
                        closeAllDropdowns();
                    }
                });







                document.querySelectorAll('.like-form').forEach(form => {
                    form.addEventListener('submit', function (event) {
                        event.preventDefault();

                        const imageId = this.dataset.imageId;
                        const icon = this.querySelector('.lcs-symbol');
                        const label = this.querySelector('.partner-label');
                        const countDiv = document.getElementById(`like-count-${imageId}`);
                        const numberSpan = countDiv.querySelector('.like-number');
                        const textSpan = countDiv.querySelector('.like-text');
                        const buttonDiv = document.getElementById(`like-button-${imageId}`);

                        fetch(`/like/${imageId}`, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            credentials: 'include'
                        })
                            .then(response => response.json())
                            .then(data => {
                                // Update icon and label
                                if (data.status === 'liked') {
                                    icon.textContent = 'thumb_up_alt';
                                    label.textContent = 'Unlike';
                                } else {
                                    icon.textContent = 'thumb_up';
                                    label.textContent = 'Like';
                                }

                                // Update like count
                                numberSpan.textContent = data.like_count;
                                textSpan.textContent = data.like_count === 1 ? 'Like' : 'Likes';

                                // Optional: style change
                                buttonDiv.classList.toggle('liked', data.status === 'liked');

                                // ✅ Fetch updated likers list
                                fetchLikers(imageId);
                            })
                            .catch(error => {
                                console.error('AJAX like error:', error);
                            });
                    });
                });

                document.addEventListener('submit', function (event) {
                    const form = event.target;

                    if (form.matches('.like-form[data-comment-id]')) {
                        event.preventDefault();

                        const commentId = form.dataset.commentId;
                        const icon = form.querySelector('.lcs-symbol');
                        const label = form.querySelector('.partner-label');
                        const countDiv = document.getElementById(`like-count-comment-${commentId}`);
                        const numberSpan = countDiv?.querySelector('.like-number');
                        const textSpan = countDiv?.querySelector('.like-text');
                        const buttonDiv = document.getElementById(`like-button-${commentId}`);

                        fetch(`/comment/like/${commentId}`, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            credentials: 'include'
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (!data) throw new Error('No data returned');

                                // Update icon and label
                                if (data.status === 'liked') {
                                    icon.textContent = 'thumb_up_alt';
                                    label.textContent = 'Unlike';
                                } else {
                                    icon.textContent = 'thumb_up';
                                    label.textContent = 'Like';
                                }

                                // Update like count, if count elements exist
                                if (numberSpan && textSpan) {
                                    numberSpan.textContent = data.like_count;
                                    textSpan.textContent = data.like_count === 1 ? 'Like' : 'Likes';
                                }

                                // Toggle 'liked' class
                                if (buttonDiv) {
                                    buttonDiv.classList.toggle('liked', data.status === 'liked');
                                }

                                // Update liker list
                                if (typeof fetchCommentLikers === 'function') {
                                    fetchCommentLikers(commentId);
                                }
                            })
                            .catch(error => {
                                console.error('AJAX comment like error:', error);
                            });
                    }
                });

                const modal = document.getElementById('profileModal');
                if (modal && modal.classList.contains('show')) {
                    showStep(currentStep);
                }

                const countrySelect = document.getElementById('country');
                const stateSelect = document.getElementById('state');
                const citySelect = document.getElementById('city');

                const selectedStateCode = "{{ user.state|default('') }}";
                const selectedCityName = "{{ user.city|default('') }}";

                if (countrySelect && stateSelect && citySelect) {
                    let allStates = [];
                    let allCities = [];

                    // Fetch all states
                    fetch('/api/get-states')
                        .then(res => res.json())
                        .then(data => {
                            allStates = data;

                            const selectedCountryIso = countrySelect.value;
                            if (selectedCountryIso) {
                                const filteredStates = allStates.filter(state => state.country_code === selectedCountryIso);
                                stateSelect.innerHTML = '<option value="">Select your region or province</option>';

                                filteredStates.forEach(state => {
                                    const option = document.createElement('option');
                                    option.value = state.state_code;
                                    option.textContent = state.name;
                                    if (state.state_code === selectedStateCode) {
                                        option.selected = true;
                                    }
                                    stateSelect.appendChild(option);
                                }

                                );

                                // If state was already selected, trigger the city fetch too
                                if (selectedStateCode) {
                                    fetchCities(selectedCountryIso, selectedStateCode);
                                }
                            }
                        });

                    // Fetch all cities (needed for change listener fallback)
                    fetch('/api/get-cities')
                        .then(res => res.json())
                        .then(data => {
                            allCities = data;
                            console.log('Fetched Cities:', allCities);
                        });

                    countrySelect.addEventListener('change', () => {
                        const selectedIso = countrySelect.options[countrySelect.selectedIndex].dataset.iso;
                        stateSelect.innerHTML = '<option value="">Select your region or province</option>';
                        citySelect.innerHTML = '<option value="">Select your city</option>';

                        if (!selectedIso) return;

                        const filteredStates = allStates.filter(state => state.country_code === selectedIso);
                        filteredStates.forEach(state => {
                            const option = document.createElement('option');
                            option.value = state.state_code;
                            option.textContent = state.name;
                            stateSelect.appendChild(option);
                        });
                    });

                    stateSelect.addEventListener('change', () => {
                        const selectedStateCode = stateSelect.value;
                        const selectedCountryIso = countrySelect.options[countrySelect.selectedIndex].dataset.iso;

                        citySelect.innerHTML = '<option value="">Select your city</option>';

                        if (!selectedStateCode || !selectedCountryIso) return;

                        fetchCities(selectedCountryIso, selectedStateCode);
                    });

                    function fetchCities(countryIso, stateCode) {
                        fetch(`/api/get-cities?country=${countryIso}&state=${stateCode}`)
                            .then(res => res.json())
                            .then(filteredCities => {
                                filteredCities.forEach(city => {
                                    const option = document.createElement('option');
                                    option.value = city.name;
                                    option.textContent = city.name;
                                    if (city.name === selectedCityName) {
                                        option.selected = true;
                                    }
                                    citySelect.appendChild(option);
                                });
                            })
                            .catch(error => {
                                console.error('Error fetching cities:', error);
                            });
                    }
                }

                let scrollPosition = 0;

                function setupOverlay(overlaySelector, openBtnId, closeBtnId, isNested = false) {
                    const overlay = document.querySelector(overlaySelector);
                    const openBtn = document.getElementById(openBtnId);
                    const closeBtn = document.getElementById(closeBtnId);

                    if (!overlay || !openBtn || !closeBtn) return;

                    openBtn.addEventListener('click', () => {
                        // 🔁 COPY INPUT VALUE
                        const taglineInput = document.querySelector('.post-tagline');
                        const captionInput = overlay.querySelector('#caption'); // safer in case multiple modals

                        if (taglineInput && captionInput) {
                            captionInput.value = taglineInput.value;
                        }

                        // 🛑 DISABLE SCROLL & SHOW OVERLAY
                        if (!isNested) {
                            scrollPosition = window.scrollY;
                            document.body.style.top = `-${scrollPosition}px`;
                            document.body.classList.add('no-scrolling');
                        }
                        overlay.classList.add('active');
                    });


                    function closeOverlay() {
                        overlay.classList.remove('active');
                        if (!isNested) {
                            document.body.classList.remove('no-scrolling');
                            document.body.style.top = '';
                            window.scrollTo(0, scrollPosition);
                        }
                    }

                    closeBtn.addEventListener('click', closeOverlay);

                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            closeOverlay();
                        }
                    });
                }

                let matchScrollPosition = 0;

                function openMatchModal(actor) {
                    const profilePic = actor.profile_pic ? `/profile_pics/${actor.profile_pic}` : '/static/pfp.jpg';
                    const levels = ["Beginner", "Intermediate", "Advanced", "Expert"];

                    // Fill modal fields
                    document.getElementById('match-fullname').textContent = actor.full_name;
                    document.getElementById('match-username').textContent = actor.full_name;
                    document.getElementById('match-role').textContent = actor.role;
                    document.getElementById('match-location').textContent = actor.location_display || "";

                    // For Skills
                    const skillsContainer = document.getElementById('match-skills');
                    skillsContainer.innerHTML = '';
                    actor.skills.forEach(skill => {
                        const span = document.createElement('span');
                        span.textContent = skill;
                        span.classList.add('info-one-match'); // Optional: add a class for styling
                        skillsContainer.appendChild(span);
                    });

                    // For Preferences
                    const prefsContainer = document.getElementById('match-preferences');
                    prefsContainer.innerHTML = '';
                    actor.preferences.forEach(pref => {
                        const span = document.createElement('span');
                        span.textContent = pref;
                        span.classList.add('info-one-match'); // Optional: add a class for styling
                        prefsContainer.appendChild(span);
                    });

                    document.getElementById('match-experience').textContent = levels[actor.experience_level];
                    document.getElementById('match-pfp-step1').src = profilePic;
                    document.getElementById('match-pfp-step2').src = profilePic;

                    // Set decline-match button data-user-id
                    document.getElementById('decline-match').setAttribute('data-user-id', actor.user_id);

                    // Freeze background scroll
                    matchScrollPosition = window.scrollY;
                    document.body.style.top = `-${matchScrollPosition}px`;
                    document.body.classList.add('no-scrolling');

                    // Show modal
                    document.getElementById('matchModal').style.display = 'flex';
                }

                window.closeMatchModal = function () {
                    const modal = document.getElementById('matchModal');
                    if (modal) modal.style.display = 'none';

                    document.body.classList.remove('no-scrolling');
                    document.body.style.top = '';
                    window.scrollTo(0, matchScrollPosition);
                };

                // Setup overlays
                setupOverlay('.overlay', 'openOverlay', 'closeOverlay');

                document.querySelectorAll('[id^="overlayLikes-"]').forEach((overlay) => {
                    const index = overlay.id.split('-')[1];
                    setupOverlay(`#overlayLikes-${index}`, `openOverlayLikes-${index}`, `closeOverlayLikes-${index}`);
                });

                document.querySelectorAll('[id^="overlayCommentLikes-"]').forEach((overlay) => {
                    const index = overlay.id.split('-')[1];
                    setupOverlay(`#overlayCommentLikes-${index}`, `openOverlayCommentLikes-${index}`, `closeOverlayCommentLikes-${index}`, true);
                });

                document.querySelectorAll('[id^="overlayComments-"]').forEach((overlay) => {
                    const index = overlay.id.split('-')[1];
                    setupOverlay(`#overlayComments-${index}`, `openOverlayComments-${index}`, `closeOverlayComments-${index}`);
                });

                document.querySelectorAll('[id^="overlayShare-"]').forEach((overlay) => {
                    const index = overlay.id.split('-')[1];
                    setupOverlay(`#overlayShare-${index}`, `openOverlayShare-${index}`, `closeOverlayShare-${index}`);
                });

                // Setup like overlay data fetch
                document.querySelectorAll('[id^="openOverlayLikes-"]').forEach((likeBtn) => {
                    const index = likeBtn.id.split('-')[1];
                    const scrollableDiv = document.getElementById(`scrollableDivLikes-${index}`);
                    const imageId = scrollableDiv?.dataset?.imageId;

                    likeBtn.addEventListener('click', () => {
                        if (!imageId || !scrollableDiv) return;

                        scrollableDiv.innerHTML = `<p class="loading-msg">Loading likes...</p>`;

                        fetch(`/likes/${imageId}`)
                            .then(res => res.json())
                            .then(data => {
                                if (data.likers.length === 0) {
                                    scrollableDiv.innerHTML = `<div class="likes-empty">
                        <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                        <div class="oops">Oops!</div>
                        <div class="nothing">Nothing to show here at the moment.</div>
                    </div>`;
                                    return;
                                }

                                const html = data.likers.map(liker => {
                                    const dateStr = new Date(liker.timestamp).toLocaleDateString('en-US', {
                                        month: 'short',
                                        day: 'numeric'
                                    });

                                    let buttonHtml = '';
                                    switch (liker.relationship) {
                                        case 'self':
                                            buttonHtml = '';
                                            break;
                                        case 'friends':
                                            buttonHtml = `
                                <button type="button" class="follow-button-profile no-margin"
                                        onclick="handleFriendship(${liker.id}, 'unfriend', this)">
                                    Unfriend
                                </button>`;
                                            break;
                                        case 'incoming_pending':
                                            buttonHtml = `
                                <div class="response-wrapper" style="margin: 0;">
                                                                        <!--AL-->
                                    <form action="/accept_request/${liker.request_id}" method="post">
                                        <button type="submit" class="follow-button-profile no-margin">Confirm</button>
                                    </form>
                                    <form action="/reject_request/${liker.request_id}" method="post">
                                        <button type="submit" class="follow-button-profile-secondary no-margin">Decline</button>
                                    </form>
                                </div>`;
                                            break;
                                        case 'outgoing_pending':
                                            buttonHtml = `
                                <form action="/cancel_request/${liker.id}" method="post">
                                    <button type="submit" class="follow-button-profile-cancel no-margin">Cancel Request</button>
                                </form>`;
                                            break;
                                        case 'outgoing_rejected':
                                        case 'not_friends':
                                            if (liker.verified) {
                                                buttonHtml = `
                                    <button type="button" class="follow-button-profile no-margin"
                                            onclick="handleFriendship(${liker.id}, 'send_request', this)">
                                        Befriend
                                    </button>`;
                                            } else {
                                                buttonHtml = `
                                    <div title="Verify your email to add friends">
        <button class="follow-button-profile-disabled no-margin" disabled>Befriend</button>
    </div>`;
                                            }
                                            break;
                                        default:
                                            buttonHtml = '';
                                    }

                                    return `
                                    <div class="profile-follow-wrapper">
                                        <div class="profile-post-likes">
                                            <a href="/profile/${liker.id}" class="pfp-link">
                                                <img src="${liker.profile_pic && liker.profile_pic !== 'pfp.jpg' ? `/profile_pics/${liker.profile_pic}` : '/static/pfp.jpg'}" class="pfp">
                                            </a>
                                            <div class="profile-name-date">
                                                <a href="/profile/${liker.id}" class="username-link">
                                                    <div class="username">${liker.name}</div>
                                                </a>
                                                <div class="date">${dateStr}</div>
                                            </div>
                                        </div>
                                        ${buttonHtml}
                                    </div>
                                `;
                                }).join('');

                                scrollableDiv.innerHTML = html;
                            })
                            .catch(err => {
                                scrollableDiv.innerHTML = `<p>Error loading likes.</p>`;
                                console.error(err);
                            });
                    });
                });












                document.querySelectorAll('.comment-form').forEach(form => {
                    form.addEventListener('submit', function (e) {
                        e.preventDefault();

                        const imageId = this.dataset.imageId;
                        const input = this.querySelector('.comment-input');
                        const commentText = input.value.trim();

                        if (!commentText) return;

                        fetch(`/comment/${imageId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ comment: commentText })
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    const comment = data.comment;

                                    const newComment = document.createElement('div');
                                    newComment.className = 'profile-comment-wrapper';
                                    newComment.id = `comment-${comment.comment_id}`;
                                    newComment.innerHTML = `
    <div class="profile-post-comments">
        <a href="/profile/${comment.user_id}">
            <img src="${comment.profile_pic && comment.profile_pic !== 'pfp.jpg'
                                            ? `/profile_pics/${comment.profile_pic}`
                                            : '/static/pfp.jpg'}" class="pfp">
        </a>
        <div class="align-top">
            <div class="profile-name-date">
                <a href="/profile/${comment.user_id}"><div class="username">${comment.name}</div></a>
                <div class="date">${new Date(comment.timestamp).toLocaleString('default', { month: 'short' })} ${new Date(comment.timestamp).getDate()}</div>
            </div>
            <span class="material-symbols-outlined delete-symbol"
                onclick="deleteComment(${comment.comment_id})">delete</span>
        </div>    
    </div>

<div class="comment-like-wrapper">
    <div class="comment">${comment.text}</div>
    <div class="like-metrics-wrapper">
        <form class="like-form" data-comment-id="${comment.comment_id}">
            <button type="submit" style="all: unset;">
                <div class="partner like-button" id="comment-like-button-${comment.comment_id}">
                    <span class="material-symbols-outlined lcs-symbol">thumb_up</span>
                    <div class="partner-label">Like</div>
                </div>
            </button>
        </form>
        <div id="openOverlayCommentLikes-0" role="button" tabindex="0" style="cursor: pointer;">
            <div class="metrics like-count" id="like-count-comment-${comment.comment_id}" data-comment-id="${comment.comment_id}">
                <span class="like-number">${comment.like_count}</span>
                <span class="like-text">${comment.like_count === 1 ? 'Like' : 'Likes'}</span>
            </div>
        </div>
    </div>
</div>
<div class="line-comments"></div>
<div class="overlayLikes" id="overlayCommentLikes-0">
    <div class="overlay-content-likes">
        <button class="close-icon">
            <span class="material-symbols-outlined overlay-close-symbol" id="closeOverlayCommentLikes-0">close</span>
        </button>
        <div class="overlay-title">Likes</div>
        <div class="scrollable-div-likes" id="scrollableDivCommentLikes-0" data-comment-id="${comment.comment_id}">
            <p class="loading-msg" style="display: none;">Loading likes...</p>
        </div>
    </div>
</div>
`;
                                    const commentList = document.getElementById(`commentList-${imageId}`);
                                    if (commentList) {
                                        // Remove empty message if it exists
                                        const overlay = form.closest('.overlay-content-comments');
                                        const emptyMessage = overlay?.querySelector('.comments-empty');
                                        if (emptyMessage) emptyMessage.remove();

                                        // Insert new comment
                                        commentList.prepend(newComment);
                                    }

                                    input.value = '';
                                } else {
                                    console.error('Failed to post comment:', data);
                                }
                            })
                            .catch(err => console.error('Error:', err));
                    });
                });





                // Setup comment like overlay data fetch
                document.querySelectorAll('[id^="openOverlayCommentLikes-"]').forEach((likeBtn) => {
                    const index = likeBtn.id.split('-')[1];
                    const scrollableDiv = document.getElementById(`scrollableDivCommentLikes-${index}`);
                    const commentId = scrollableDiv?.dataset?.commentId;

                    likeBtn.addEventListener('click', () => {
                        if (!commentId || !scrollableDiv) return;

                        scrollableDiv.innerHTML = `<p class="loading-msg">Loading likes...</p>`;

                        fetch(`/comment/likes/${commentId}`)
                            .then(res => res.json())
                            .then(data => {
                                if (!data.likers || data.likers.length === 0) {
                                    scrollableDiv.innerHTML = `<div class="likes-empty">
                        <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
                        <div class="oops">Oops!</div>
                        <div class="nothing">Nothing to show here at the moment.</div>
                    </div>`;
                                    return;
                                }

                                const html = data.likers.map(liker => {
                                    const dateStr = new Date(liker.timestamp).toLocaleDateString('en-US', {
                                        month: 'short',
                                        day: 'numeric'
                                    });

                                    let buttonHtml = '';
                                    switch (liker.relationship) {
                                        case 'self':
                                            buttonHtml = '';
                                            break;
                                        case 'friends':
                                            buttonHtml = `
                                <form action="/unfriend/${liker.id}" method="post">
                                    <button type="submit" class="follow-button-profile no-margin">Unfriend</button>
                                </form>`;
                                            break;
                                        case 'incoming_pending':
                                            buttonHtml = `
                                <div class="response-wrapper" style="margin: 0;">
                                    <!--AL-->
                                    <form action="/accept_request/${liker.request_id}" method="post">
                                        <button type="submit" class="follow-button-profile no-margin">Confirm</button>
                                    </form>
                                    <form action="/reject_request/${liker.request_id}" method="post">
                                        <button type="submit" class="follow-button-profile-secondary no-margin">Decline</button>
                                    </form>
                                </div>`;
                                            break;
                                        case 'outgoing_pending':
                                            buttonHtml = `
                                <form action="/cancel_request/${liker.id}" method="post">
                                    <button type="submit" class="follow-button-profile-cancel no-margin">Cancel Request</button>
                                </form>`;
                                            break;
                                        case 'outgoing_rejected':
                                        case 'not_friends':
                                            if (liker.verified) {
                                                buttonHtml = `
                                    <form action="/send_request/${liker.id}" method="post">
                                        <button type="submit" class="follow-button-profile no-margin">Befriend</button>
                                    </form>`;
                                            } else {
                                                buttonHtml = `
                                    <div title="Verify your email to add friends">
        <button class="follow-button-profile-disabled no-margin" disabled>Befriend</button>
    </div>`;
                                            }
                                            break;
                                        default:
                                            buttonHtml = '';
                                    }

                                    return `
                                    <div class="profile-follow-wrapper">
                                        <div class="profile-post-likes">
                                            <a href="/profile/${liker.id}" class="pfp-link">
                                                <img <img src="${liker.profile_pic && liker.profile_pic !== 'pfp.jpg' ? `/profile_pics/${liker.profile_pic}` : '/static/pfp.jpg'}" class="pfp">
                                            </a>
                                            <div class="profile-name-date">
                                                <a href="/profile/${liker.id}" class="username-link">
                                                    <div class="username">${liker.name}</div>
                                                </a>
                                                <div class="date">${dateStr}</div>
                                            </div>
                                        </div>
                                        ${buttonHtml}
                                    </div>
                                `;
                                }).join('');

                                scrollableDiv.innerHTML = html;
                            })
                            .catch(err => {
                                scrollableDiv.innerHTML = `<p>Error loading likes.</p>`;
                                console.error("Comment like overlay error:", err);
                            });
                    });
                });





                document.querySelectorAll('.save-button').forEach(button => {
                    button.addEventListener('click', function (event) {
                        event.preventDefault();  // <-- Prevent the default anchor behavior (jump to top)

                        const imageId = this.dataset.imageId;
                        const isSaved = this.classList.contains('saved');
                        const frame = this.closest('.frame1');

                        fetch(`/${isSaved ? 'unsave' : 'save'}/${imageId}`, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include'
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'saved') {
                                    button.classList.add('saved');
                                    button.textContent = 'Unsave';
                                } else if (data.status === 'unsaved') {
                                    button.classList.remove('saved');
                                    button.textContent = 'Save';
                                }

                                if (frame) {
                                    frame.style.display = 'none';
                                }
                            })
                            .catch(error => console.error('Error:', error));
                    });
                });

















                const moreBtns = document.querySelectorAll('.more-symbol');
                const allFrames1 = document.querySelectorAll('.frame1');

                const pfp = document.getElementById('pfp');
                const frame2 = document.getElementById('frame2');
                const pfp3 = document.getElementById('pfp3');
                const frame3 = document.getElementById('frame3');
                const pfp4 = document.getElementById('pfp4');
                const frame4 = document.getElementById('frame4');

                allFrames1.forEach(frame => frame.style.display = 'none');
                if (frame2) frame2.style.display = 'none';
                if (frame3) frame3.style.display = 'none';
                if (frame4) frame4.style.display = 'none';

                let isFrame234Open = false;

                moreBtns.forEach((btn, index) => {
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const currentFrame = document.getElementById(`frame1-${index + 1}`);
                        const isOpen = currentFrame.style.display === 'block';

                        allFrames1.forEach(frame => frame.style.display = 'none');

                        currentFrame.style.display = isOpen ? 'none' : 'block';

                        if (frame2) frame2.style.display = 'none';
                        if (frame3) frame3.style.display = 'none';
                        if (frame4) frame4.style.display = 'none';
                        isFrame234Open = false;
                    });
                });

                if (pfp) {
                    pfp.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const isOpen = frame2.style.display === 'block';
                        if (isOpen) {
                            frame2.style.display = 'none';
                            frame3.style.display = 'none';
                            frame4.style.display = 'none';
                            isFrame234Open = false;
                        } else {
                            frame2.style.display = 'block';
                            frame3.style.display = 'block';
                            frame4.style.display = 'block';
                            allFrames1.forEach(frame => frame.style.display = 'none');
                            isFrame234Open = true;
                        }
                    });
                }

                if (pfp3) {
                    pfp3.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const isOpen = frame3.style.display === 'block';
                        if (isOpen) {
                            frame2.style.display = 'none';
                            frame3.style.display = 'none';
                            frame4.style.display = 'none';
                            isFrame234Open = false;
                        } else {
                            frame2.style.display = 'block';
                            frame3.style.display = 'block';
                            frame4.style.display = 'block';
                            allFrames1.forEach(frame => frame.style.display = 'none');
                            isFrame234Open = true;
                        }
                    });
                }

                if (pfp4) {
                    pfp4.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const isOpen = frame4.style.display === 'block';
                        if (isOpen) {
                            frame2.style.display = 'none';
                            frame3.style.display = 'none';
                            frame4.style.display = 'none';
                            isFrame234Open = false;
                        } else {
                            frame2.style.display = 'block';
                            frame3.style.display = 'block';
                            frame4.style.display = 'block';
                            allFrames1.forEach(frame => frame.style.display = 'none');
                            isFrame234Open = true;
                        }
                    });
                }

                document.addEventListener('click', function (event) {
                    moreBtns.forEach((btn, index) => {
                        const frame = document.getElementById(`frame1-${index + 1}`);
                        if (!frame) return;

                        const clickedInsideFrame = frame.contains(event.target);
                        const clickedButton = event.target === btn;

                        if (!clickedInsideFrame && !clickedButton) {
                            frame.style.display = 'none';
                        }
                    });

                    if (frame2 && !frame2.contains(event.target) && event.target !== pfp) {
                        frame2.style.display = 'none';
                    }
                    if (frame3 && !frame3.contains(event.target) && event.target !== pfp3) {
                        frame3.style.display = 'none';
                    }
                    if (frame4 && !frame4.contains(event.target) && event.target !== pfp4) {
                        frame4.style.display = 'none';
                    }

                    const frame2Visible = frame2 && window.getComputedStyle(frame2).display !== 'none';
                    const frame3Visible = frame3 && window.getComputedStyle(frame3).display !== 'none';
                    const frame4Visible = frame4 && window.getComputedStyle(frame4).display !== 'none';

                    if (!frame2Visible && !frame3Visible && !frame4Visible) {
                        isFrame234Open = false;
                    }
                });

                window.addEventListener('resize', function () {
                    if (isFrame234Open) {
                        frame2.style.display = 'block';
                        frame3.style.display = 'block';
                        frame4.style.display = 'block';
                    }
                });

                function checkScrollbar() {
                    const imageInput = document.getElementById('image');
                    const div = document.getElementById('scrollableDiv');
                    const likeDivs = document.querySelectorAll('[id^="scrollableDivLikes"]');
                    const commentLikeDivs = document.querySelectorAll('[id^="scrollableDivCommentLikes"]');
                    const commentDivs = document.querySelectorAll('[id^="scrollableDivComments"]');

                    if (imageInput && div) {
                        div.classList.remove('no-scroll', 'has-scroll');
                        if (imageInput.files.length > 0) {
                            div.classList.add('has-scroll');
                        } else {
                            div.classList.add('no-scroll');
                        }
                    }

                    const checkScrollState = (divList) => {
                        divList.forEach(el => {
                            el.classList.remove('no-scroll', 'has-scroll');
                            if (el.scrollHeight > el.clientHeight) {
                                el.classList.add('has-scroll');
                            } else {
                                el.classList.add('no-scroll');
                            }
                        });
                    };

                    checkScrollState(likeDivs);
                    checkScrollState(commentDivs);
                    checkScrollState(commentLikeDivs);
                }

                window.addEventListener("load", () => {
                    requestAnimationFrame(() => {
                        checkScrollbar();
                    });
                });



                const imageInput = document.getElementById('image');
                if (imageInput) {
                    imageInput.addEventListener('change', checkScrollbar);
                }
                checkScrollbar();

                function isChrome() {
                    return /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
                }

                function setFullHeight() {
                    const adjustment = isChrome() ? 1 : 0;
                    const adjustedHeight = Math.floor(window.innerHeight) - adjustment;

                    const rightSidebar = document.querySelector('.right-sidebar');
                    const leftSidebar = document.querySelector('.left-sidebar');

                    if (rightSidebar) rightSidebar.style.height = adjustedHeight + 'px';
                    if (leftSidebar) leftSidebar.style.height = adjustedHeight + 'px';
                }

                window.addEventListener('resize', setFullHeight);
                setFullHeight();

                const imageInputPreview = document.getElementById('image');
                const imageWrapper = document.getElementById('imageWrapper');
                const imagePreview = document.getElementById('uploadedImagePreview');
                const closeButton = document.getElementById('closeButton');
                const scrollableDiv = document.querySelector('.scrollable-div');
                const collaboratorTagSection = document.getElementById('collaboratorTagSection'); // New

                if (imageInputPreview) {
                    imageInputPreview.addEventListener('change', function () {
                        const file = this.files[0];

                        if (file && file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                imagePreview.src = e.target.result;
                                imageWrapper.style.display = 'block';

                                if (collaboratorTagSection) {
                                    collaboratorTagSection.style.display = 'block';
                                }
                            };
                            reader.readAsDataURL(file);
                        } else {
                            imagePreview.src = '';
                            imageWrapper.style.display = 'none';

                            if (collaboratorTagSection) {
                                collaboratorTagSection.style.display = 'none';
                            }
                        }
                    });
                }

                if (closeButton) {
                    closeButton.addEventListener('click', function (e) {
                        e.preventDefault();
                        imagePreview.src = '';
                        imageWrapper.style.display = 'none';
                        imageInputPreview.value = '';

                        if (collaboratorTagSection) {
                            collaboratorTagSection.style.display = 'none';
                        }

                        if (scrollableDiv) {
                            scrollableDiv.classList.remove('has-scroll');
                            scrollableDiv.classList.add('no-scroll');
                        }
                    });
                }

                const circledClose = document.querySelector('.circled-icon-1-overlay-version');
                if (circledClose) {
                    circledClose.addEventListener('click', function () {
                        document.getElementById('uploadedImagePreview').src = '';
                        document.getElementById('image').value = '';
                        document.getElementById('imageWrapper').style.display = 'none';

                        if (collaboratorTagSection) {
                            collaboratorTagSection.style.display = 'none';
                        }

                        if (scrollableDiv) {
                            scrollableDiv.classList.remove('has-scroll');
                            scrollableDiv.classList.add('no-scroll');
                        }
                    });
                }

                const profileForm = document.getElementById('profileForm');
                if (profileForm) {
                    console.log('Form found');

                    profileForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        console.log('Form submission prevented');

                        const formData = new FormData(this);

                        // Append all form data into a single array
                        const dataArray = [];
                        for (const [key, value] of formData.entries()) {
                            dataArray.push([key, value]);
                        }
                        console.log('Form data as array:', dataArray);

                        try {
                            console.log('Sending data to the server...');
                            const response = await fetch('/api/setup-profile', {
                                method: 'POST',
                                body: formData
                            });

                            console.log('Response received:', response);
                            const result = await response.json();
                            console.log('Parsed result:', result);

                            if (result.success) {
                                console.log('Profile saved successfully');
                                document.getElementById('profileModal').style.display = 'none';
                                window.location.href = result.redirect_url;
                            } else {
                                console.log('Something went wrong while saving the profile');
                                alert('Something went wrong while saving your profile.');
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('An error occurred. Please try again.');
                        }
                    });
                } else {
                    console.log('Form not found');
                }

                document.getElementById('notify-btn').addEventListener('click', function () {
                    const recipientId = this.getAttribute('data-recipient-id');

                    fetch('/notify/collab_check', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ recipient_id: recipientId })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert('Error: ' + data.error);
                            } else {
                                alert(data.message);
                                // Immediately redirect after alert is dismissed
                                window.location.href = data.redirect_url;
                            }
                        })
                        .catch(err => alert('Request failed: ' + err));
                });


            });

            window.respondToRequest = function (requestId, action, buttonElement) {
                const userId = buttonElement.getAttribute('data-userid');

                fetch(`/${action}_request/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include'
                })
                    .then(res => res.json())
                    .then(data => {
                        if (!data.success) {
                            alert(data.message || 'Something went wrong.');
                            return;
                        }

                        const wrapper = buttonElement.closest('.response-wrapper');
                        if (!wrapper) return;

                        if (action === 'accept') {
                            wrapper.innerHTML = `
                <button type="button" class="follow-button-profile"
                    onclick="handleFriendship(${userId}, 'unfriend', this)">
                    Unfriend
                </button>
            `;
                        } else if (action === 'reject') {
                            wrapper.innerHTML = `
                <button type="button" class="follow-button-profile"
                    onclick="handleFriendship(${userId}, 'send_request', this)">
                    Befriend
                </button>
            `;
                        }
                    })
                    .catch(err => {
                        console.error(`${action} request error:`, err);
                        alert('Error performing action.');
                    });
            };


        </script>
</body>

</html>