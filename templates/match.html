{% extends "base.html" %}
{% block content %}

<div class="card">
    <div class="post-title">Match</div>

    {% if users %}
    {% for user in users %}
    <div class="nav-section active card-content" style="margin-bottom: 20px;">
        <div class="photo" style="background: url('{{ user.profile_pic_url }}') center center / cover no-repeat;"></div>
        <div class="info">
            <div class="name-card">{{ user.first_name }}</div>
            <div class="who">{{ user.role }}</div>
            <div class="icons">
                {% if user.facebook %}
                <a href="{{ 'https://facebook.com/' + user.facebook if 'facebook.com' not in user.facebook else user.facebook }}"
                    target="_blank">
                    <img src="{{ url_for('static', filename='fb.png') }}" alt="Facebook" class="icon1">
                </a>
                {% endif %}
                {% if user.email %}
                <a href="mailto:{{ user.email }}">
                    <img src="{{ url_for('static', filename='gmail.png') }}" alt="Gmail" class="icon2">
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="nav-section card-content-two">
        <div class="info-sandp">
            <div class="info-title">Top Skills</div>
            <div class="info-content">
                {% for skill in user.skills[:3] %}
                <div class="info-one">{{ skill }}</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="nav-section card-content-two">
        <div class="info-sandp">
            <div class="info-title">Top Preferences</div>
            <div class="info-content">
                {% for pref in user.preferences[:3] %}
                <div class="info-one">{{ pref }}</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="nav-section card-content-two">
        {% set exp_map = ['Beginner', 'Intermediate', 'Advanced', 'Expert'] %}
        <div class="info-sandp">
            <div class="info-title">Experience Level</div>
            <div class="info-content">
                {% if user.experience_level %}
                <div class="info-one">{{ exp_map[user.experience_level - 1] }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="request-icons" style="justify-content: center; margin-bottom: 40px;">
        <button class="circled-icon-1">
            <span class="material-symbols-outlined close-symbol">close</span>
        </button>
        <button class="circled-icon-2" id="notify-btn" data-recipient-id="{{ user.id }}">
            <span class="material-symbols-outlined check-symbol">check</span>
        </button>
    </div>
    {% endfor %}
    {% else %}
    <div class="notifs-empty">
        <span class="material-symbols-outlined empty-symbol">sentiment_dissatisfied</span>
        <div class="oops">Oops!</div>
        <div class="nothing">Nothing to show here at the moment.</div>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let declinedCount = 0;
        let locked = false;

        const closeButtons = document.querySelectorAll(".circled-icon-1");
        const checkButtons = document.querySelectorAll(".circled-icon-2");

        closeButtons.forEach(button => {
            button.addEventListener("click", () => {
                if (locked) return;

                const card = button.closest(".nav-section").parentElement;
                card.style.display = "none";
                declinedCount++;

                if (declinedCount === 3) {
                    lockMatchRoute();
                }
            });
        });

        checkButtons.forEach(button => {
            button.addEventListener("click", () => {
                if (locked) return;

                const recipientId = button.getAttribute("data-recipient-id");

                // Optional: send a notification to the accepted user
                fetch("/send_notification", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        recipient_id: recipientId,
                        notif_type: "collab_request"
                    })
                });

                // Lock the route after accepting
                lockMatchRoute();
            });
        });

        function lockMatchRoute() {
            locked = true;

            fetch("/lock_match_route", {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            }).then(() => {
                console.log("Match route locked.");
            }).catch(err => {
                console.error("Failed to lock match route:", err);
            });
        }
    });
</script>


{% endblock %}